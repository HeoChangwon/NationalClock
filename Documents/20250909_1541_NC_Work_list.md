# NationalClock 작업 내용 정리
**날짜**: 2025-09-09 15:41  
**세션**: 설정 저장/복원 및 테마 적용 문제 해결

## 해결된 주요 문제

### 1. 프로그램 아이콘 설정
- **문제**: NationalClock.ico 파일을 프로그램 아이콘으로 사용하도록 설정 필요
- **해결책**:
  - `NationalClock.csproj`에 `<ApplicationIcon>` 및 `<Resource>` 추가
  - MainWindow.xaml, SettingsWindow.xaml에 Pack URI 형식으로 아이콘 경로 설정
  - `pack://application:,,,/Resources/NationalClock.ico` 사용

### 2. 버전 정보 표시 시스템
- **문제**: 프로그램명, 버전명, 빌드날짜를 제목표시줄에 표시하고 중앙 관리 필요
- **해결책**:
  - `VersionInfo.cs` 클래스 생성으로 버전 정보 중앙화
  - Assembly 메타데이터에서 자동으로 버전 정보 읽어오도록 구현
  - `NationalClock.csproj`에서 MSBuild 속성으로 버전 관리

### 3. Framework-dependent 배포 설정
- **문제**: NSIS Installer 제작을 위한 Framework-dependent 배포 방식 변경
- **해결책**:
  - `NationalClock.csproj`에 배포 설정 추가
  - Publish 프로필 생성 (x64, x86)
  - `SelfContained=false`, `UseAppHost=true` 설정

### 4. 제목 표시 분리
- **문제**: 제목표시줄과 클라이언트 영역에 다른 정보 표시 필요
- **해결책**:
  - `WindowTitle`: 전체 버전 정보 (`"NationalClock v1.0.001 (Build: 2025-09-09 16:30)"`)
  - `ClientTitle`: 앱 이름 + 시계 개수 (`"National Clock (3 clocks)"`)
  - MainViewModel에 별도 속성 추가

### 5. WPF Stylus 입력 오류 수정
- **문제**: `System.InvalidOperationException` - WispLogic.RegisterStylusDeviceCore 오류
- **해결책**:
  - App.xaml.cs에 `DisableStylusAndTouch()` 메서드 추가
  - `AppContext.SetSwitch` 및 리플렉션 백업 방법 구현

### 6. NullReferenceException 수정
- **문제**: SettingsViewModel RemoveTimeZone에서 null 참조 오류
- **해결책**:
  - 모든 LINQ 쿼리에 `.Where(tz => tz != null)` 필터 추가
  - EnabledTimeZones, AvailableTimeZones 컬렉션의 null 안전성 강화
  - MainViewModel, SettingsViewModel에서 일관된 null 체크 적용

## 현재 진행중인 문제

### 1. 화면 위치 복원 문제 ✅ **해결완료**
- **문제**: 프로그램 재실행 시 창 위치가 유지되지 않음
- **원인**: `WindowStartupLocation="CenterScreen"`이 LoadWindowSettings 덮어쓰기
- **해결책**: `WindowStartupLocation="Manual"`로 변경
- **상태**: ✅ 완료 - 화면 위치 정상 복원됨

### 2. 테마 적용 문제 🔄 **진행중**
- **문제**: 프로그램 재실행 시 이전 테마(Dark Mode)가 적용되지 않음
- **현재 상태**: 
  - 설정 파일에는 `"isDarkMode": true` 정상 저장됨
  - 테마 초기화 순서 문제 수정 완료
  - 상세한 디버그 로깅 추가 완료
- **추가된 디버깅**:
  - ThemeManager 생성 과정 추적
  - IsDarkMode setter 호출 확인
  - ApplyTheme 메서드 실행 로깅
  - Material Design 테마 적용 과정 추적

## 구현된 기능들

### 설정 관리 시스템
- JSON 파일 기반 설정 저장 (`%LocalAppData%\NationalClock\settings.json`)
- 창 위치, 크기, 상태 자동 저장/복원
- 테마, 시간 형식, 타임존 설정 영속성
- 설정 유효성 검증 및 복구 메커니즘

### 버전 관리 시스템
- 중앙화된 버전 정보 관리 (`VersionInfo.cs`)
- Assembly 메타데이터 활용 자동 버전 표시
- MSBuild 속성과 연동한 일관된 버전 관리

### 디버깅 시스템
- 포괄적인 디버그 로깅 시스템
- 설정 로딩/저장 과정 추적
- 테마 적용 과정 상세 로깅
- 윈도우 위치 복원 과정 모니터링

## 파일 변경 사항

### 새로 생성된 파일
- `VersionInfo.cs` - 버전 정보 중앙 관리
- `Properties/PublishProfiles/FrameworkDependent-x64.pubxml` - x64 배포 프로필
- `Properties/PublishProfiles/FrameworkDependent-x86.pubxml` - x86 배포 프로필

### 주요 수정된 파일
- `NationalClock.csproj` - 아이콘, 버전, 배포 설정 추가
- `MainWindow.xaml` - WindowStartupLocation, 아이콘 설정
- `MainWindow.xaml.cs` - 설정 복원 로직 및 디버깅 강화
- `App.xaml.cs` - Stylus 오류 수정, 테마 초기화 순서 개선
- `MainViewModel.cs` - 제목 분리, null 안전성, 디버깅 로깅
- `SettingsViewModel.cs` - null 참조 오류 수정, 안전성 강화
- `ThemeManager.cs` - 테마 적용 로직 개선, 상세 디버깅
- `TimeZoneManager.cs` - 타임존 업데이트 로직 디버깅 강화

## 다음 단계 (추천 작업)

### 1. 테마 적용 문제 최종 해결
- 현재 추가된 디버그 로깅으로 문제점 정확히 식별
- Material Design 테마 적용 메커니즘 최적화
- ThemeManager 초기화 로직 검토

### 2. 타임존 표시 문제 해결
- Settings의 EnabledTimeZones 복원 확인
- ClockService와 TimeZoneManager 연동 점검
- UI 업데이트 메커니즘 검증

### 3. NSIS Installer 제작 준비
- Framework-dependent 빌드 최종 검증
- .NET 8 Runtime 종속성 체크 로직 추가
- 설치/제거 과정에서 설정 파일 보존 로직

## 기술적 개선 사항

### 코드 품질
- 포괄적인 null 안전성 검증 추가
- 예외 처리 및 오류 복구 메커니즘 강화
- 디버깅 및 로깅 시스템 체계화

### 아키텍처
- 설정 관리의 중앙화 및 일관성 확보
- 버전 관리 시스템의 자동화
- 서비스 간 의존성 최적화

### 사용성
- 창 위치/크기 복원으로 사용자 경험 개선
- 설정 영속성으로 일관된 사용 환경 제공
- 오류 상황에서의 안정성 확보